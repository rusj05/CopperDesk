<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Copper FX Optimizer</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #214d9b;
      color: #fff;
      padding: 40px;
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .panel, .chart-container {
      background: #111;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
    }
    h1, h2 {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      margin-top: 5px;
      border: none;
      background-color: #222;
      color: white;
      font-size: 1rem;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background-color: #00cc66;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      color: white;
    }
    button:hover {
      background-color: #00b359;
    }
    .result {
      margin-top: 20px;
      font-size: 1rem;
      line-height: 1.6;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
    .info-box {
      margin-top: 30px;
      background: #1c1c1c;
      padding: 20px;
      border-radius: 10px;
      font-size: 0.9rem;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Copper FX Optimizer</h1>
    <div id="livePrice">Copper Price: loading...</div>

    <label>Select Purchase Currency (currency you pay copper in)</label>
    <select id="buyCurrency"></select>

    <label>Select Sale Currency (currency you sell copper in)</label>
    <select id="sellCurrency"></select>

    <label>Current FX Rate (Buy â†’ Sell)</label>
    <div id="fxRateDisplay">FX Rate: loading...</div>

    <label>Quantity (tonnes)</label>
    <input type="number" id="quantity" value="1" min="0" />

    <label>Bank FX Rate (Buy â†’ Sell)</label>
    <input type="number" id="bankRate" value="0" min="0" step="0.0001" />

    <label>Purchase Price per tonne</label>
    <input type="number" id="purchasePrice" value="0" min="0" />

    <label>Selling Price per tonne</label>
    <input type="number" id="sellPrice" value="0" min="0" />

    <label>Freight per tonne</label>
    <input type="number" id="freight" value="0" min="0" />

    <label>Insurance per tonne</label>
    <input type="number" id="insurance" value="0" min="0" />

    <label>Import Duty per tonne</label>
    <input type="number" id="duty" value="0" min="0" />

    <button id="calcBtn">Calculate</button>
    <div class="result" id="results"></div>
    <button id="exportBtn">ðŸ“¥ Download Trade Log (CSV)</button>

    <div class="info-box">
      <strong>Currency Info:</strong><br>
      USD is the global benchmark for copper. If you're buying copper in EUR and selling in DKK, make sure your bank's FX rate does not deviate too far from the current market rate. This helps reduce currency exposure and protect profits.
    </div>
  </div>

  <div class="chart-container">
    <h2>Copper Price Trend</h2>
    <canvas id="copperChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const currencies = ["USD", "CAD", "DKK", "EUR", "GBP", "JPY", "NOK", "SEK"];
    const buySelect = document.getElementById("buyCurrency");
    const sellSelect = document.getElementById("sellCurrency");

    currencies.forEach(c => {
      const opt1 = document.createElement("option");
      opt1.value = c;
      opt1.textContent = c;
      buySelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = c;
      opt2.textContent = c;
      sellSelect.appendChild(opt2);
    });
    buySelect.value = "USD";
    sellSelect.value = "DKK";

    async function getFXRate(from, to) {
      if (from === to) return 1;
      const res = await fetch(`https://api.frankfurter.app/latest?amount=1&from=${from}&to=${to}`);
      const data = await res.json();
      return data.rates[to];
    }

    async function updateFXRateDisplay() {
      const rate = await getFXRate(buySelect.value, sellSelect.value);
      document.getElementById("fxRateDisplay").textContent = `Market FX Rate: 1 ${buySelect.value} = ${rate.toFixed(4)} ${sellSelect.value}`;
    }

    buySelect.addEventListener("change", updateFXRateDisplay);
    sellSelect.addEventListener("change", updateFXRateDisplay);
    updateFXRateDisplay();

    async function getLiveCopperPrice() {
      try {
        const res = await fetch("https://api.metalpriceapi.com/v1/latest?base=USD&symbols=COPPER&apikey=43551205d0f8f8ce6fe40f6e79c3aa0b");
        const data = await res.json();
        return data.rates.COPPER;
      } catch (err) {
        return 8305.74;
      }
    }

    const tradeLog = [];

    async function calculate() {
      const buy = buySelect.value;
      const sell = sellSelect.value;
      const qty = parseFloat(document.getElementById("quantity").value) || 0;
      const bankRate = parseFloat(document.getElementById("bankRate").value) || 0;
      const purchasePrice = parseFloat(document.getElementById("purchasePrice").value) || 0;
      const sellPrice = parseFloat(document.getElementById("sellPrice").value) || 0;
      const freight = parseFloat(document.getElementById("freight").value) || 0;
      const insurance = parseFloat(document.getElementById("insurance").value) || 0;
      const duty = parseFloat(document.getElementById("duty").value) || 0;

      const copperUSD = await getLiveCopperPrice();
      const livePriceText = `Copper Price: ${copperUSD.toFixed(2)} USD per metric tonne (via MetalpriceAPI)`;
      document.getElementById("livePrice").textContent = livePriceText;

      const convertedPurchasePrice = purchasePrice * bankRate;
      const landedCost = convertedPurchasePrice + freight + insurance + duty;
      const totalCost = landedCost * qty;
      const revenue = sellPrice * qty;
      const profit = revenue - totalCost;
      const margin = totalCost ? (profit / totalCost) * 100 : 0;

      document.getElementById("results").innerHTML =
        `Total Purchase Cost: ${totalCost.toFixed(2)} ${sell}<br>` +
        `Potential Profit: ${profit.toFixed(2)} ${sell}<br>` +
        `Margin: ${margin.toFixed(2)} %<br>` +
        `Bank FX Rate Used: ${bankRate}`;

      tradeLog.push({
        Date: new Date().toISOString().split("T")[0],
        BuyCurrency: buy,
        SellCurrency: sell,
        Quantity: qty,
        PurchasePrice: purchasePrice,
        CopperUSD: copperUSD,
        BankRate: bankRate,
        TotalCost: totalCost,
        SellPrice: sellPrice,
        Profit: profit,
        Margin: margin.toFixed(2)
      });
    }

    document.getElementById("calcBtn").addEventListener("click", calculate);
    document.getElementById("exportBtn").addEventListener("click", () => {
      const csvRows = [];
      const headers = Object.keys(tradeLog[0]);
      csvRows.push(headers.join(","));
      for (const row of tradeLog) {
        const values = headers.map(h => JSON.stringify(row[h] ?? ""));
        csvRows.push(values.join(","));
      }
      const csv = csvRows.join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.setAttribute("href", url);
      a.setAttribute("download", "copper_trade_log.csv");
      a.click();
    });

    const ctx = document.getElementById("copperChart").getContext("2d");
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
        datasets: [{
          label: 'Copper Price (USD)',
          data: [8250, 8300, 8280, 8320, 8340],
          borderColor: '#00ff99',
          borderWidth: 2,
          fill: false
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#fff' } }
        },
        scales: {
          x: { ticks: { color: '#fff' } },
          y: { ticks: { color: '#fff' } }
        }
      }
    });
  </script>
</body>
</html>
