<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CopperDesk | FX & Trade Health Tool</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #1c3b6f, #214d9b);
      color: #fff;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }
    .panel, .chart-container {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      width: 100%;
      max-width: 500px;
    }
    h1, h2 {
      margin-bottom: 20px;
      text-align: center;
    }
    .helper {
      font-size: 0.96rem;
      color: #b2eaff;
      background: #1c2845;
      border-radius: 6px;
      padding: 7px 12px;
      margin-bottom: 18px;
      margin-top: -12px;
      text-align: center;
    }
    label {
      display: block;
      margin-top: 15px;
      font-size: 0.95rem;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .currency-symbol {
      min-width: 28px;
      text-align: right;
      font-weight: bold;
      font-size: 1.1em;
      color: #88eeff;
    }
    select, input[type="number"] {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      margin-top: 5px;
      border: none;
      background-color: #222;
      color: white;
      font-size: 1rem;
    }
    input.invalid {
      border: 2px solid #ff3333;
      background: #330808;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background-color: #00cc66;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      color: white;
      transition: background 0.2s;
    }
    button:active { background: #00994c; }
    .tooltip, .explain-link {
      cursor: pointer;
      text-decoration: underline dotted;
      color: #ffe066;
      margin-left: 6px;
      font-size: 1.08em;
      vertical-align: middle;
    }
    .explain-link {
      text-decoration: underline dashed;
      color: #ffae42;
    }
    .info-popup {
      display: none;
      position: absolute;
      background: #222c38;
      color: #fff;
      border-radius: 8px;
      padding: 14px 17px;
      z-index: 999;
      max-width: 310px;
      min-width: 120px;
      font-size: 0.98em;
      box-shadow: 0 6px 32px rgba(12,22,32,0.35);
      margin-top: 8px;
      border: 1px solid #315585;
    }
    .info-popup.visible { display: block; }
    .info-popup .close-popup {
      color: #ffe066;
      float: right;
      cursor: pointer;
      margin-left: 12px;
      font-size: 1.05em;
    }
    .explanation-section {
      background: #1b2a36;
      border-radius: 7px;
      margin-top: 20px;
      padding: 12px 14px;
      color: #d8fdff;
      font-size: 0.98em;
    }
    .explanation-section summary {
      color: #ffe066;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 7px;
      font-size: 1.07em;
    }
    .result, .score-output {
      margin-top: 20px;
      font-size: 1.08rem;
      line-height: 1.6;
      padding: 14px;
      border-radius: 8px;
      min-height: 28px;
      font-weight: bold;
      transition: background 0.3s, color 0.3s;
    }
    .result.success, .score-output.success { background: #163c26; color: #5ff7b8;}
    .result.warning, .score-output.warning { background: #4c4018; color: #ffe066;}
    .result.danger, .score-output.danger { background: #43111d; color: #ff6f8a;}
    .breakdown-table {
      width: 100%; margin-top: 16px;
      border-collapse: collapse;
      font-size: 0.98rem;
      background: #181d2b;
      border-radius: 8px;
      overflow: hidden;
    }
    .breakdown-table th, .breakdown-table td {
      padding: 7px 10px;
      text-align: left;
      border-bottom: 1px solid #232942;
    }
    .breakdown-table tr:last-child td { border-bottom: none; }
    .risk-flag {
      color: #ffd966;
      font-size: 1.2em;
      vertical-align: middle;
      margin-left: 8px;
      cursor: pointer;
    }
    .api-error {
      color: #ff7675;
      background: #2e1717;
      padding: 6px 14px;
      border-radius: 6px;
      margin-top: 8px;
      display: block;
      font-size: 0.97em;
    }
    .chart-container canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 140px !important;
      margin-top: 8px;
      display: block;
    }
    @media (min-width: 700px) {
      .chart-container canvas {
        max-height: 68px !important;
      }
    }
    @media (min-width: 800px) {
      body {
        flex-direction: row;
        justify-content: center;
        flex-wrap: wrap;
      }
      .panel, .chart-container { margin: 12px;}
    }
  </style>
</head>
<body>
  <div class="panel" aria-label="CopperDesk Trade Panel">
    <h1>
      CopperDesk 
      <span class="tooltip" data-info="general">ℹ</span>
    </h1>
    <div class="helper">
      <b>Quickly analyse your trade and FX health.</b> 
      <span class="explain-link" data-info="howitworks">(How does this work?)</span>
    </div>

    <label for="metal">
      Select Metal 
      <span class="tooltip" title="Choose which metal you're buying or selling. Live prices update below." data-info="metal">ℹ</span>
    </label>
    <select id="metal" aria-label="Metal type">
      <option value="XCU">Copper</option>
      <option value="XAU">Gold</option>
    </select>
    <div id="livePrice">
      Metal Price: loading... (USD/t) <span id="metalSpinner" class="loading" style="display:inline-block;"></span>
    </div>
    <span id="metalApiError" class="api-error" style="display:none;"></span>

    <label for="buyCurrency">
      Buy Currency 
      <span class="tooltip" title="The currency you use to purchase the metal. Used for cost calculation and FX conversion." data-info="buycur">ℹ</span>
    </label>
    <select id="buyCurrency" aria-label="Buy currency"></select>

    <label for="sellCurrency">
      Sell Currency 
      <span class="tooltip" title="The currency you receive or invoice in. Used to calculate profit, margin, and risk." data-info="sellcur">ℹ</span>
    </label>
    <select id="sellCurrency" aria-label="Sell currency"></select>
    <div id="fxRate">
      Exchange Rate (buy → sell): loading... <span id="fxSpinner" class="loading" style="display:inline-block;"></span>
      <span class="tooltip" data-info="fxrate">ℹ</span>
    </div>
    <span id="fxApiError" class="api-error" style="display:none;"></span>

    <label for="purchasePrice">
      Purchase Price per tonne (Buy Currency)
      <span class="tooltip" data-info="purchasePrice">ℹ</span>
    </label>
    <div class="input-row">
      <span id="purchaseSymbol" class="currency-symbol"></span>
      <input id="purchasePrice" type="number" min="0" value="8200" aria-label="Purchase price"/>
    </div>

    <label for="quantity">
      Quantity (tonnes)
      <span class="tooltip" data-info="quantity">ℹ</span>
    </label>
    <div class="input-row">
      <span class="currency-symbol"></span>
      <input id="quantity" type="number" min="0" value="10" aria-label="Quantity"/>
    </div>

    <label for="freight">
      Freight per tonne (Sell Currency)
      <span class="tooltip" data-info="freight">ℹ</span>
    </label>
    <div class="input-row">
      <span id="freightSymbol" class="currency-symbol"></span>
      <input id="freight" type="number" min="0" value="0" aria-label="Freight"/>
    </div>

    <label for="insurance">
      Insurance per tonne (Sell Currency)
      <span class="tooltip" data-info="insurance">ℹ</span>
    </label>
    <div class="input-row">
      <span id="insuranceSymbol" class="currency-symbol"></span>
      <input id="insurance" type="number" min="0" value="0" aria-label="Insurance"/>
    </div>

    <label for="duty">
      Import Duty per tonne (Sell Currency)
      <span class="tooltip" data-info="duty">ℹ</span>
    </label>
    <div class="input-row">
      <span id="dutySymbol" class="currency-symbol"></span>
      <input id="duty" type="number" min="0" value="0" aria-label="Duty"/>
    </div>

    <label for="sellingPrice">
      Selling Price per tonne (Sell Currency)
      <span class="tooltip" data-info="sellingPrice">ℹ</span>
    </label>
    <div class="input-row">
      <span id="sellingSymbol" class="currency-symbol"></span>
      <input id="sellingPrice" type="number" min="0" value="8300" aria-label="Selling price"/>
    </div>

    <label for="paymentTerm">
      Payment Terms (Incoterm)
      <span class="tooltip" data-info="incoterm">ℹ</span>
    </label>
    <select id="paymentTerm" aria-label="Payment term"></select>
    <div id="incotermDesc" class="helper" style="display:none;"></div>

    <button id="calcBtn" onclick="calculate()" aria-label="Calculate">Calculate</button>
    <div class="result" id="result"></div>
    <div class="score-output" id="score"></div>
    <div id="breakdown"></div>

    <details class="explanation-section" id="outputExplain" open>
      <summary>What do these results mean?</summary>
      <div>
        <b>Profit:</b> Your estimated profit for the whole trade.<br/>
        <b>Margin:</b> Percentage of profit vs. cost.<br/>
        <b>Trade Score:</b> Shows risk and health based on your margin and payment terms.<br/>
        <b>Risk Warnings:</b> If margin is low, you may want to review your costs or sales price.<br/>
      </div>
    </details>
  </div>

  <div class="chart-container" aria-label="FX Rate Trend">
    <h2>
      FX Rate Trend 
      <span class="tooltip" data-info="chart">ℹ</span>
    </h2>
    <canvas id="fxChart" height="70"></canvas>
  </div>

  <!-- Info Popups for Tooltips -->
  <div id="infoPopups"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // --- Currency Symbol Map ---
    const currencySymbols = {
      USD: "$",
      EUR: "€",
      DKK: "kr",
      GBP: "£",
      CAD: "$",
      NOK: "kr",
      SEK: "kr",
      JPY: "¥"
    };

    // --- Incoterms Definitions ---
    const incoterms = [
      { value: "FOB", label: "FOB (Free On Board)", desc: "Seller delivers goods on board vessel at port of shipment. Buyer bears all costs and risks after loading." },
      { value: "CIF", label: "CIF (Cost, Insurance, Freight)", desc: "Seller pays for cost, insurance, freight to named port. Risk passes to buyer when goods loaded on vessel." },
      { value: "EXW", label: "EXW (Ex Works)", desc: "Buyer bears all costs/risk from seller's premises onwards." },
      { value: "DAP", label: "DAP (Delivered at Place)", desc: "Seller delivers to a named place. Buyer pays for import duties/taxes." },
      { value: "DDP", label: "DDP (Delivered Duty Paid)", desc: "Seller responsible for all costs and risks, including duties/taxes, to deliver at destination." },
      { value: "FCA", label: "FCA (Free Carrier)", desc: "Seller delivers goods to carrier or other person nominated by buyer at seller’s premises or another named place." },
      { value: "CPT", label: "CPT (Carriage Paid To)", desc: "Seller pays freight to named place. Risk transfers once delivered to first carrier." },
      { value: "CIP", label: "CIP (Carriage and Insurance Paid To)", desc: "Seller pays freight/insurance to destination. Risk passes to buyer at carrier handover." },
      { value: "FAS", label: "FAS (Free Alongside Ship)", desc: "Seller delivers alongside ship at named port. Buyer bears costs/risk from that point." },
      { value: "CFR", label: "CFR (Cost and Freight)", desc: "Seller pays costs/freight to port. Risk passes when goods loaded on vessel." },
      { value: "DAT", label: "DAT (Delivered at Terminal)", desc: "Seller delivers to named terminal at destination. Buyer pays import duties." },
      // LC options
      { value: "LC30", label: "Letter of Credit (30 Days)", desc: "Payment via letter of credit, payable 30 days after shipment/documents." },
      { value: "LC60", label: "Letter of Credit (60 Days)", desc: "Payment via letter of credit, payable 60 days after shipment/documents." },
      { value: "LC90", label: "Letter of Credit (90 Days)", desc: "Payment via letter of credit, payable 90 days after shipment/documents." }
    ];

    // --- Info explanations ---
    const infoData = {
      general: "CopperDesk helps you estimate the profit, risk, and FX impact of a metal trade, including real-time prices and currency rates.",
      howitworks: `
        <b>How CopperDesk works:</b><br>
        1. Enter your costs, prices, and payment terms.<br>
        2. Get live market prices and FX rates.<br>
        3. Calculate profit, margin, and risk.<br>
        4. Review warnings and breakdowns to optimise your trade.<br>
      `,
      metal: "Select the metal to get live international prices. Supported: Copper and Gold.",
      buycur: "The currency you will pay to purchase the metal.",
      sellcur: "The currency you will receive, or use for sales/invoice.",
      fxrate: "Current exchange rate from Buy to Sell currency. Used to convert your cost to the sales currency.",
      purchasePrice: "How much you pay (per tonne) for the metal, in the buy currency.",
      quantity: "Number of tonnes for this trade.",
      freight: "Transport cost per tonne, paid in sell currency.",
      insurance: "Insurance cost per tonne, in sell currency.",
      duty: "Import duty per tonne (in sell currency).",
      sellingPrice: "How much you sell per tonne for, in the sell currency.",
      incoterm: "Payment and delivery terms. Hover or click for description. Incoterms define who pays for what and when risk transfers.",
      chart: "Shows FX rate movement for your selected currency pair in the last 10 days."
    };

    // --- Selectors ---
    const buyCurrency = document.getElementById("buyCurrency");
    const sellCurrency = document.getElementById("sellCurrency");
    const fxRateDisplay = document.getElementById("fxRate");
    const fxChartCanvas = document.getElementById("fxChart").getContext("2d");
    const metalSelect = document.getElementById("metal");
    const paymentTerm = document.getElementById("paymentTerm");
    const incotermDesc = document.getElementById("incotermDesc");
    const infoPopups = document.getElementById("infoPopups");

    // Currency symbols near inputs
    const purchaseSymbol = document.getElementById("purchaseSymbol");
    const freightSymbol = document.getElementById("freightSymbol");
    const insuranceSymbol = document.getElementById("insuranceSymbol");
    const dutySymbol = document.getElementById("dutySymbol");
    const sellingSymbol = document.getElementById("sellingSymbol");

    // Spinners and error elements
    const fxSpinner = document.getElementById("fxSpinner");
    const metalSpinner = document.getElementById("metalSpinner");
    const fxApiError = document.getElementById("fxApiError");
    const metalApiError = document.getElementById("metalApiError");

    // Inputs
    const purchaseInput = document.getElementById("purchasePrice");
    const quantityInput = document.getElementById("quantity");
    const freightInput = document.getElementById("freight");
    const insuranceInput = document.getElementById("insurance");
    const dutyInput = document.getElementById("duty");
    const sellingInput = document.getElementById("sellingPrice");
    const calcBtn = document.getElementById("calcBtn");

    // Breakdown and output
    const breakdownDiv = document.getElementById("breakdown");
    const resultDiv = document.getElementById("result");
    const scoreDiv = document.getElementById("score");

    // --- Currency options setup ---
    const currencies = ["USD", "EUR", "DKK", "GBP", "CAD", "NOK", "SEK", "JPY"];
    currencies.forEach(c => {
      buyCurrency.add(new Option(c, c));
      sellCurrency.add(new Option(c, c));
    });
    buyCurrency.value = "USD";
    sellCurrency.value = "DKK";

    // --- Incoterm options ---
    incoterms.forEach(opt => paymentTerm.add(new Option(opt.label, opt.value)));
    paymentTerm.value = "FOB";
    // Show incoterm description on select
    function showIncotermDesc() {
      const sel = incoterms.find(opt => opt.value === paymentTerm.value);
      if (sel) {
        incotermDesc.style.display = "block";
        incotermDesc.textContent = sel.desc;
      } else {
        incotermDesc.style.display = "none";
      }
    }
    paymentTerm.onchange = showIncotermDesc;
    showIncotermDesc();

    // --- State ---
    let fxRate = 1.0;
    let fxChartInstance = null;
    let lastFxDebounce, lastMetalDebounce;

    // --- Accessibility: input ARIA error states ---
    function setInvalid(input, invalid) {
      if (invalid) {
        input.classList.add("invalid");
        input.setAttribute("aria-invalid", "true");
      } else {
        input.classList.remove("invalid");
        input.removeAttribute("aria-invalid");
      }
    }

    // --- Spinner display helper ---
    function showSpinner(spinner, show) {
      spinner.style.display = show ? "inline-block" : "none";
    }

    // --- Error display helper ---
    function showApiError(element, msg) {
      element.style.display = msg ? "block" : "none";
      element.textContent = msg || "";
    }

    // --- Currency symbol update ---
    function updateCurrencySymbols() {
      purchaseSymbol.textContent = currencySymbols[buyCurrency.value] || buyCurrency.value;
      [freightSymbol, insuranceSymbol, dutySymbol, sellingSymbol].forEach(sym => {
        sym.textContent = currencySymbols[sellCurrency.value] || sellCurrency.value;
      });
    }

    buyCurrency.onchange = () => { updateCurrencySymbols(); debounceFX(); };
    sellCurrency.onchange = () => { updateCurrencySymbols(); debounceFX(); };
    metalSelect.onchange = () => debounceMetal();

    updateCurrencySymbols();

    // --- Debounce helpers ---
    function debounceFX() {
      if (lastFxDebounce) clearTimeout(lastFxDebounce);
      showSpinner(fxSpinner, true);
      showApiError(fxApiError, "");
      lastFxDebounce = setTimeout(updateFXRateAndChart, 350);
    }
    function debounceMetal() {
      if (lastMetalDebounce) clearTimeout(lastMetalDebounce);
      showSpinner(metalSpinner, true);
      showApiError(metalApiError, "");
      lastMetalDebounce = setTimeout(getMetalPrice, 350);
    }

    // --- Responsive aspect ratio ---
    function getAspectRatio() {
      return window.innerWidth > 700 ? 5 : 2.2;
    }

    // --- FX Rate and Chart (with spinner, error) ---
    async function updateFXRateAndChart() {
      const from = buyCurrency.value;
      const to = sellCurrency.value;
      showSpinner(fxSpinner, true);
      showApiError(fxApiError, "");
      if (from === to) {
        fxRate = 1.0;
        fxRateDisplay.childNodes[0].textContent = "Exchange Rate: 1.0";
        showSpinner(fxSpinner, false);
        if (fxChartInstance) fxChartInstance.destroy();
        return;
      }
      try {
        const end = new Date().toISOString().split("T")[0];
        const start = new Date(Date.now() - 10 * 86400000).toISOString().split("T")[0];
        const res = await fetch(`https://api.frankfurter.app/${start}..${end}?from=${from}&to=${to}`);
        if (!res.ok) throw new Error("API error");
        const data = await res.json();
        const entries = Object.entries(data.rates);
        const labels = entries.map(([date]) => date);
        const values = entries.map(([, val]) => val[to]).filter(v => typeof v === "number");
        if (!values.length) throw new Error("No rates data");
        fxRate = values.at(-1);
        fxRateDisplay.childNodes[0].textContent = `Exchange Rate (${from} → ${to}): ${fxRate.toFixed(4)}`;
        if (fxChartInstance) fxChartInstance.destroy();
        fxChartInstance = new Chart(fxChartCanvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: `${from} → ${to}`,
              data: values,
              borderColor: '#00ff99',
              borderWidth: 2,
              fill: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: getAspectRatio(),
            plugins: { legend: { labels: { color: '#fff' } } },
            scales: {
              x: { ticks: { color: '#fff' } },
              y: { ticks: { color: '#fff' } }
            }
          }
        });
        showSpinner(fxSpinner, false);
      } catch (e) {
        showApiError(fxApiError, "Failed to load FX rates. Please try again.");
        fxRateDisplay.childNodes[0].textContent = "Exchange Rate: unavailable";
        fxRate = 1.0;
        if (fxChartInstance) fxChartInstance.destroy();
        showSpinner(fxSpinner, false);
      }
    }

    // --- Responsive resizing for aspect ratio ---
    window.addEventListener('resize', () => {
      if (fxChartInstance) {
        fxChartInstance.options.aspectRatio = getAspectRatio();
        fxChartInstance.resize();
      }
    });

    // --- Metal Price (with spinner, error) ---
    async function getMetalPrice() {
      const metal = metalSelect.value;
      showSpinner(metalSpinner, true);
      showApiError(metalApiError, "");
      try {
        const res = await fetch(`https://api.metalpriceapi.com/v1/latest?api_key=43551205d0f8f8ce6fe40f6e79c3aa0b&base=USD&currencies=${metal}`);
        if (!res.ok) throw new Error("API error");
        const data = await res.json();
        const price = data.rates?.[metal];
        if (typeof price !== "number" || price <= 0) throw new Error();
        document.getElementById("livePrice").childNodes[0].textContent =
          `${metal === 'XCU' ? 'Copper' : 'Gold'} Price: ${price.toFixed(2)} USD/t`;
        showSpinner(metalSpinner, false);
      } catch {
        showApiError(metalApiError, "Failed to load metal price. Please try again.");
        document.getElementById("livePrice").childNodes[0].textContent = "Metal Price: unavailable";
        showSpinner(metalSpinner, false);
      }
    }

    // --- Validation logic ---
    function validateInputs() {
      let valid = true;
      [purchaseInput, quantityInput, freightInput, insuranceInput, dutyInput, sellingInput].forEach(inp => {
        const v = Number(inp.value);
        if (isNaN(v) || v < 0) {
          setInvalid(inp, true);
          valid = false;
        } else {
          setInvalid(inp, false);
        }
      });
      return valid;
    }

    // --- Calculation, logic & breakdown ---
    function calculate() {
      // Validate
      if (!validateInputs()) {
        resultDiv.textContent = "Please fill all values with valid, non-negative numbers.";
        resultDiv.className = "result danger";
        scoreDiv.textContent = "";
        breakdownDiv.innerHTML = "";
        return;
      }
      // Fetch values
      const purchasePrice = parseFloat(purchaseInput.value);
      const quantity = parseFloat(quantityInput.value);
      const freight = parseFloat(freightInput.value);
      const insurance = parseFloat(insuranceInput.value);
      const duty = parseFloat(dutyInput.value);
      const sellingPrice = parseFloat(sellingInput.value);
      const selIncoterm = incoterms.find(opt => opt.value === paymentTerm.value);
      const paymentLabel = selIncoterm ? selIncoterm.label : paymentTerm.value;
      const paymentDesc = selIncoterm ? selIncoterm.desc : "";
      const metalPriceText = document.getElementById("livePrice").childNodes[0].textContent;
      const fxRateSafe = (typeof fxRate === "number" && !isNaN(fxRate)) ? fxRate : 1.0;

      // Calculations
      const totalCost = (purchasePrice * fxRateSafe + freight + insurance + duty) * quantity;
      const totalRevenue = sellingPrice * quantity;
      const profit = totalRevenue - totalCost;
      const margin = totalCost ? (profit / totalCost) * 100 : 0;

      // Score
      let score = 0;
      if (margin > 20) score += 3;
      else if (margin > 10) score += 2;
      else if (margin > 0) score += 1;
      if (paymentTerm.value.includes("LC")) {
        const days = parseInt(paymentTerm.value.replace("LC", ""));
        if (days <= 30) score += 2;
        else if (days <= 60) score += 1;
      } else {
        score += 2;
      }

      // Verdict & color
      let verdict = "", color = "";
      if (score >= 5) { verdict = "✅ Strong Trade"; color = "success";}
      else if (score >= 3) { verdict = "🟡 Moderate Trade"; color = "warning";}
      else { verdict = "🔴 Risky Trade"; color = "danger"; }

      resultDiv.innerHTML = `
        <b>Profit:</b> <span title="Total revenue minus all costs">${profit.toLocaleString(undefined,{maximumFractionDigits:2})}</span> &nbsp;|&nbsp;
        <b>Margin:</b> <span title="(Profit / Total Cost) x 100">${margin.toFixed(2)}%</span>
        <span class="explain-link" data-info="margin">(What is this?)</span>
      `;
      resultDiv.className = "result " + color;

      // Risk flag: margin < 5%
      let riskFlag = "";
      if (margin < 5) {
        riskFlag = `<span class="risk-flag" tabindex="0" title="Margin below 5%.\nThis trade carries higher risk and low reward.">&#9888;</span>`;
      } else if (margin < 0) {
        riskFlag = `<span class="risk-flag" tabindex="0" title="Negative margin.\nYou will make a loss at these values.">&#9888;</span>`;
      }

      scoreDiv.innerHTML = `
        <b>Trade Score:</b> ${score}/6 — <b>${verdict}</b> ${riskFlag}<br>
        <span style="font-weight:normal; color:#ffe066;">
        Payment: <u title="${paymentDesc}">${paymentLabel}</u>
        </span>
        <span class="explain-link" data-info="tradescore">(Explain)</span>
      `;
      scoreDiv.className = "score-output " + color;

      // --- Breakdown table ---
      breakdownDiv.innerHTML = `
      <table class="breakdown-table" aria-label="Calculation Breakdown">
        <tr><th>Metal Price</th><td>${metalPriceText}</td></tr>
        <tr><th>FX Rate</th><td>${fxRateSafe.toFixed(4)} (${buyCurrency.value}→${sellCurrency.value})</td></tr>
        <tr><th>Purchase Price/tonne</th><td>${currencySymbols[buyCurrency.value] || buyCurrency.value} ${purchasePrice.toLocaleString()}</td></tr>
        <tr><th>Freight/tonne</th><td>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${freight.toLocaleString()}</td></tr>
        <tr><th>Insurance/tonne</th><td>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${insurance.toLocaleString()}</td></tr>
        <tr><th>Duty/tonne</th><td>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${duty.toLocaleString()}</td></tr>
        <tr><th>Selling Price/tonne</th><td>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${sellingPrice.toLocaleString()}</td></tr>
        <tr><th>Quantity</th><td>${quantity.toLocaleString()} t</td></tr>
        <tr><th>Total Cost</th><td><strong>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${totalCost.toLocaleString(undefined, {maximumFractionDigits:2})}</strong></td></tr>
        <tr><th>Total Revenue</th><td><strong>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${totalRevenue.toLocaleString(undefined, {maximumFractionDigits:2})}</strong></td></tr>
        <tr><th>Profit</th><td><strong>${currencySymbols[sellCurrency.value] || sellCurrency.value} ${profit.toLocaleString(undefined, {maximumFractionDigits:2})}</strong></td></tr>
        <tr><th>Margin</th><td><strong>${margin.toFixed(2)}%</strong> ${riskFlag}</td></tr>
      </table>
      `;
    }

    // --- Input change handlers to remove invalid highlight live ---
    [purchaseInput, quantityInput, freightInput, insuranceInput, dutyInput, sellingInput].forEach(inp => {
      inp.addEventListener('input', () => setInvalid(inp, false));
    });

    // --- Tooltip/Explain info popup logic ---
    function showInfoPopup(e, content) {
      let popup = document.createElement('div');
      popup.className = 'info-popup visible';
      popup.innerHTML = `<span class="close-popup" title="Close">×</span>${content}`;
      popup.style.top = (e.clientY + window.scrollY + 12) + "px";
      popup.style.left = (e.clientX + window.scrollX - 10) + "px";
      infoPopups.appendChild(popup);
      function close() { popup.remove(); }
      popup.querySelector('.close-popup').onclick = close;
      setTimeout(() => {
        document.addEventListener('click', function removeDocClick(ev) {
          if (!popup.contains(ev.target)) {
            close();
            document.removeEventListener('click', removeDocClick);
          }
        });
      }, 0);
    }
    function addPopupListeners() {
      document.querySelectorAll('.tooltip, .explain-link').forEach(el => {
        el.onclick = e => {
          e.stopPropagation();
          let info = el.getAttribute('data-info');
          if (info && infoData[info]) showInfoPopup(e, infoData[info]);
        };
      });
    }
    // Add margin/tradescore explanations
    infoData.margin = `<b>Margin</b> = (Profit / Total Cost) × 100<br>
      Margin tells you the percentage of your revenue that is profit. A higher margin generally means a healthier trade.<br>
      <b>Margin under 5%</b> is flagged as risky.`;
    infoData.tradescore = `<b>Trade Score</b> = (Margin + Payment terms) health.<br>
      A higher score indicates more favorable conditions and lower risk.<br>
      Payment via Letters of Credit (LC) increases risk the longer the payment delay.`;

    // Add output explanations for first load and after calc
    addPopupListeners();

    // --- Initial load ---
    debounceFX();
    debounceMetal();

    // Show info popups on hover for tooltips (optional: only for desktop)
    document.querySelectorAll('.tooltip').forEach(el => {
      el.addEventListener('mouseenter', e => {
        let info = el.getAttribute('data-info');
        if (info && infoData[info]) showInfoPopup(e, infoData[info]);
      });
    });

    // Re-attach popup listeners after calculation
    calcBtn.addEventListener('click', () => setTimeout(addPopupListeners, 200));

    // Accessibility: keyboard focus for risk tooltip (aria-labels already used)
  </script>
</body>
</html>
