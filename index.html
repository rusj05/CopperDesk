<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Copper FX Optimizer</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #214d9b;
      color: #fff;
      padding: 40px;
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .panel, .chart-container, .strategy-panel, .hedging-panel {
      background: #111;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
    }
    h1, h2, h3 {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      margin-top: 5px;
      border: none;
      background-color: #222;
      color: white;
      font-size: 1rem;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background-color: #00cc66;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      color: white;
    }
    button:hover {
      background-color: #00b359;
    }
    .result {
      margin-top: 20px;
      font-size: 1rem;
      line-height: 1.6;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Copper FX Optimizer</h1>
    <div id="livePrice">Copper Price: loading...</div>

    <label>Select Purchase Currency</label>
    <select id="purchaseCurrency"></select>

    <label>Select Sale Currency</label>
    <select id="saleCurrency"></select>

    <label>Quantity (tonnes)</label>
    <input type="number" id="quantity" value="1" min="0" />

    <label>Bank FX Rate (Purchase â†’ Sale)</label>
    <input type="number" id="bankRate" value="0" min="0" step="0.0001" />

    <label>Purchase Price per tonne</label>
    <input type="number" id="purchasePrice" value="0" min="0" />

    <label>Selling Price per tonne</label>
    <input type="number" id="sellPrice" value="0" min="0" />

    <label>Freight per tonne</label>
    <input type="number" id="freight" value="0" min="0" />

    <label>Insurance per tonne</label>
    <input type="number" id="insurance" value="0" min="0" />

    <label>Import Duty per tonne</label>
    <input type="number" id="duty" value="0" min="0" />

    <button id="calcBtn">Calculate</button>
    <div class="result" id="results"></div>
    <button id="exportBtn">ðŸ“¥ Download Trade Log (CSV)</button>
  </div>

  <div class="strategy-panel">
    <h2>Multi-Currency Strategy</h2>
    <div id="strategyOutput">Compare profitability if purchasing in different currencies...</div>
  </div>

  <div class="hedging-panel">
    <h2>FX Risk & Hedging Insight</h2>
    <div id="hedgingAdvice">Enter FX rate to evaluate hedging impact...</div>
  </div>

  <div class="chart-container">
    <h2>Copper Price Trend</h2>
    <canvas id="copperChart"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const currencies = ["USD", "CAD", "DKK", "EUR", "GBP", "JPY", "NOK", "SEK"];
    const purchaseCurrency = document.getElementById("purchaseCurrency");
    const saleCurrency = document.getElementById("saleCurrency");

    currencies.forEach(c => {
      const opt1 = document.createElement("option");
      opt1.value = c;
      opt1.textContent = c;
      purchaseCurrency.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = c;
      opt2.textContent = c;
      saleCurrency.appendChild(opt2);
    });
    purchaseCurrency.value = "USD";
    saleCurrency.value = "DKK";

    async function getLiveCopperPrice() {
      try {
        const res = await fetch("https://api.metalpriceapi.com/v1/latest?base=USD&symbols=COPPER&apikey=43551205d0f8f8ce6fe40f6e79c3aa0b");
        const data = await res.json();
        return data.rates.COPPER;
      } catch (err) {
        return 8305.74;
      }
    }

    async function getRate(from, to) {
      if (from === to) return 1;
      const res = await fetch(`https://api.frankfurter.app/latest?amount=1&from=${from}&to=${to}`);
      const data = await res.json();
      return data.rates[to];
    }

    const tradeLog = [];

    async function calculate() {
      const buyCur = purchaseCurrency.value;
      const sellCur = saleCurrency.value;
      const qty = parseFloat(document.getElementById("quantity").value) || 0;
      const bankRate = parseFloat(document.getElementById("bankRate").value) || 0;
      const sell = parseFloat(document.getElementById("sellPrice").value) || 0;
      const buy = parseFloat(document.getElementById("purchasePrice").value) || 0;
      const freight = parseFloat(document.getElementById("freight").value) || 0;
      const insurance = parseFloat(document.getElementById("insurance").value) || 0;
      const duty = parseFloat(document.getElementById("duty").value) || 0;

      const copperUSD = await getLiveCopperPrice();
      const liveRate = await getRate(buyCur, sellCur);
      const convertedCost = buy * bankRate + freight + insurance + duty;
      const totalCost = convertedCost * qty;
      const revenue = sell * qty;
      const profit = revenue - totalCost;
      const margin = totalCost ? (profit / totalCost) * 100 : 0;
      const breakevenRate = sell ? ((buy + freight + insurance + duty) / sell).toFixed(4) : 0;

      document.getElementById("livePrice").textContent = `Copper Price: ${copperUSD} USD/t (live)`;
      document.getElementById("results").innerHTML =
        `Total Cost: ${totalCost.toFixed(2)} ${sellCur}<br>` +
        `Profit: ${profit.toFixed(2)} ${sellCur}<br>` +
        `Margin: ${margin.toFixed(2)} %<br>` +
        `Bank FX Rate Used: ${bankRate} (${buyCur} â†’ ${sellCur})<br>` +
        `Live FX Rate: ${liveRate.toFixed(4)}<br>` +
        `Breakeven FX Rate: ${breakevenRate}`;

      document.getElementById("hedgingAdvice").innerHTML =
        `To avoid losses, ensure your FX rate is better than <strong>${breakevenRate}</strong>.`;

      const strategyMsg = await Promise.all(
        currencies.filter(c => c !== sellCur).map(async cur => {
          const rate = await getRate(cur, sellCur);
          const localCost = buy * rate + freight + insurance + duty;
          const costTotal = localCost * qty;
          const altProfit = revenue - costTotal;
          const altMargin = costTotal ? (altProfit / costTotal) * 100 : 0;
          return `<p>If buying in ${cur} at market rate (${rate.toFixed(4)}): Margin = ${altMargin.toFixed(2)}%</p>`;
        })
      );
      document.getElementById("strategyOutput").innerHTML = strategyMsg.join("");
    }

    document.getElementById("calcBtn").addEventListener("click", calculate);
  </script>
</body>
</html>
