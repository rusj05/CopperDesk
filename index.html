<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Copper FX Optimizer</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #214d9b;
      color: #fff;
      padding: 40px;
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .panel, .chart-container, .info-panel {
      background: #111;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-width: 500px;
      width: 100%;
    }
    h1, h2 {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      font-size: 0.9rem;
    }
    select, input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      margin-top: 5px;
      border: none;
      background-color: #222;
      color: white;
      font-size: 1rem;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background-color: #00cc66;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      color: white;
    }
    button:hover {
      background-color: #00b359;
    }
    .result, .info-panel {
      margin-top: 20px;
      font-size: 1rem;
      line-height: 1.6;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Copper FX Optimizer</h1>
    <div id="livePrice">Copper Price: loading... (USD/t)</div>

    <label>Buy Currency (Currency you buy copper in)</label>
    <select id="buyCurrency"></select>

    <label>Sell Currency (Currency you sell copper in)</label>
    <select id="sellCurrency"></select>

    <div id="fxRateDisplay">Exchange Rate: loading...</div>

    <label>Purchase Price per tonne</label>
    <input type="number" id="purchasePrice" value="0" min="0" />

    <label>Quantity (tonnes)</label>
    <input type="number" id="quantity" value="1" min="0" />

    <label>Bank Conversion Rate (Buy â†’ Sell Currency)</label>
    <input type="number" id="bankRate" value="0" min="0" step="0.0001" />

    <label>Selling Price per tonne</label>
    <input type="number" id="sellPrice" value="0" min="0" />

    <label>Freight per tonne</label>
    <input type="number" id="freight" value="0" min="0" />

    <label>Insurance per tonne</label>
    <input type="number" id="insurance" value="0" min="0" />

    <label>Import Duty per tonne</label>
    <input type="number" id="duty" value="0" min="0" />

    <button id="calcBtn">Calculate</button>
    <div class="result" id="results"></div>
    <div class="result" id="breakevenSummary"></div>
    <button id="exportBtn">ðŸ“¥ Download Trade Log (CSV)</button>
  </div>

  <div class="chart-container">
    <h2>Copper Price Trend</h2>
    <select id="chartCurrencyToggle">
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="DKK">DKK</option>
    </select>
    <canvas id="copperChart"></canvas>
  </div>

  <div class="info-panel">
    <h2>Currency Tips</h2>
    <p>
      The live copper price shown above reflects the market value in USD per metric tonne.
      Use your bankâ€™s provided FX rate to calculate your actual costs. If you're buying in one currency and selling in another,
      enter the rate your bank offers for converting between them. Use the breakeven rate as a guide to ensure profitability.
    </p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const currencies = ["USD", "CAD", "DKK", "EUR", "GBP", "JPY", "NOK", "SEK"];
    const buyCurrencySelect = document.getElementById("buyCurrency");
    const sellCurrencySelect = document.getElementById("sellCurrency");
    const chartCurrencyToggle = document.getElementById("chartCurrencyToggle");

    currencies.forEach(c => {
      const opt1 = new Option(c, c);
      const opt2 = new Option(c, c);
      buyCurrencySelect.appendChild(opt1);
      sellCurrencySelect.appendChild(opt2);
    });
    buyCurrencySelect.value = "USD";
    sellCurrencySelect.value = "DKK";

    async function getFXRate(from, to) {
      if (from === to) return 1;
      const res = await fetch(`https://api.frankfurter.app/latest?amount=1&from=${from}&to=${to}`);
      const data = await res.json();
      return data.rates[to];
    }

    async function updateFXDisplay() {
      const from = buyCurrencySelect.value;
      const to = sellCurrencySelect.value;
      const rate = await getFXRate(from, to);
      document.getElementById("fxRateDisplay").textContent = `Exchange Rate (${from} â†’ ${to}): ${rate.toFixed(4)}`;
    }

    buyCurrencySelect.addEventListener("change", updateFXDisplay);
    sellCurrencySelect.addEventListener("change", updateFXDisplay);
    updateFXDisplay();

    async function calculate() {
      const buyCur = buyCurrencySelect.value;
      const sellCur = sellCurrencySelect.value;
      const qty = parseFloat(document.getElementById("quantity").value) || 0;
      const bankRate = parseFloat(document.getElementById("bankRate").value) || 0;
      const sell = parseFloat(document.getElementById("sellPrice").value) || 0;
      const freight = parseFloat(document.getElementById("freight").value) || 0;
      const insurance = parseFloat(document.getElementById("insurance").value) || 0;
      const duty = parseFloat(document.getElementById("duty").value) || 0;
      const purchasePrice = parseFloat(document.getElementById("purchasePrice").value) || 0;

      const copperPrice = purchasePrice * bankRate;
      const landedCost = copperPrice + freight + insurance + duty;
      const totalCost = landedCost * qty;
      const revenue = sell * qty;
      const profit = revenue - totalCost;
      const margin = totalCost ? (profit / totalCost) * 100 : 0;
      const breakevenRate = purchasePrice ? ((sell - freight - insurance - duty) / purchasePrice).toFixed(4) : "N/A";

      document.getElementById("livePrice").textContent = `Copper Price: ${purchasePrice} ${buyCur}/t (Live Market Price)`;
      document.getElementById("results").innerHTML =
        `Total Purchase Cost: ${totalCost.toFixed(2)} ${sellCur}<br>` +
        `Potential Profit: ${profit.toFixed(2)} ${sellCur}<br>` +
        `Margin: ${margin.toFixed(2)} %<br>` +
        `Bank FX Rate Used: ${bankRate}`;

      document.getElementById("breakevenSummary").innerHTML =
        `ðŸ§® Breakeven FX Rate (to avoid loss): ${breakevenRate}`;
    }

    document.getElementById("calcBtn").addEventListener("click", calculate);

    const ctx = document.getElementById("copperChart").getContext("2d");
    let chart;
    function drawChart(currency) {
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
          datasets: [{
            label: `Copper Price (${currency})`,
            data: currency === "USD" ? [8250, 8300, 8280, 8320, 8340] : [7700, 7740, 7720, 7780, 7800],
            borderColor: '#00ff99',
            borderWidth: 2,
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: '#fff' } }
          },
          scales: {
            x: { ticks: { color: '#fff' } },
            y: { ticks: { color: '#fff' } }
          }
        }
      });
    }

    chartCurrencyToggle.addEventListener("change", e => drawChart(e.target.value));
    drawChart("USD");
  </script>
</body>
</html>
