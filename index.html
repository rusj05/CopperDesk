<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CopperDesk PRO | FX, Trade & Learning Tool</title>
  <style>
    /* ... (same CSS as in your pasted code, omitted for brevity, but keep your last version) ... */
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: linear-gradient(to bottom, #1c3b6f, #214d9b); color: #fff; padding: 0; }
    #main-wrap { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 26px; padding: 24px 4vw 60px 4vw; min-height: 100vh;}
    .panel, .chart-container, .ai-tutor-panel, .learning-dashboard { background: #111; padding: 20px; border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,0.33); width: 100%; max-width: 530px;}
    .ai-tutor-panel { max-width: 360px; min-width: 270px; position: sticky; top: 24px; height: max-content; }
    .panel, .learning-dashboard { min-width: 320px;}
    h1, h2, h3 { margin-bottom: 16px; text-align: center;}
    .feature-banner { background: #154d32; border-radius: 9px; padding: 9px 16px; margin-bottom: 12px; color: #b7f6be; font-size: 1.01em;}
    .helper { font-size: 0.97rem; color: #b2eaff; background: #1c2845; border-radius: 7px; padding: 7px 12px; margin-bottom: 18px; text-align: center;}
    .btn, button { padding: 11px 20px; background: #00b48a; border: none; border-radius: 7px; font-weight: bold; color: white; cursor: pointer; margin: 10px 0 0 0; font-size: 1.02em;}
    .btn:hover, button:hover { background: #008066;}
    .btn-small { font-size: 0.99em; padding: 5px 14px; margin-right: 7px;}
    .label-row { display: flex; align-items: center; gap: 8px;}
    label { margin-top: 14px; font-size: 0.98em;}
    .input-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px;}
    .currency-symbol { min-width: 28px; text-align: right; font-weight: bold; font-size: 1.1em; color: #88eeff;}
    select, input[type="number"], input[type="text"], textarea { width: 100%; padding: 9px; border-radius: 7px; margin-top: 4px; border: none; background-color: #222; color: white; font-size: 1rem;}
    textarea { resize: vertical; min-height: 44px;}
    input.invalid, textarea.invalid { border: 2px solid #ff3333; background: #330808;}
    .tooltip, .explain-link { cursor: pointer; text-decoration: underline dotted; color: #ffe066; margin-left: 7px; font-size: 1.05em; vertical-align: middle;}
    .explain-link { text-decoration: underline dashed; color: #ffae42;}
    .glossary-link { color: #69f2d6; text-decoration: underline; cursor: pointer; margin-left: 8px; font-size:1.02em;}
    .result, .score-output { margin-top: 20px; font-size: 1.08rem; line-height: 1.6; padding: 14px; border-radius: 8px; min-height: 28px; font-weight: bold;}
    .result.success, .score-output.success { background: #163c26; color: #5ff7b8;}
    .result.warning, .score-output.warning { background: #4c4018; color: #ffe066;}
    .result.danger, .score-output.danger { background: #43111d; color: #ff6f8a;}
    .breakdown-table { width: 100%; margin-top: 16px; border-collapse: collapse; font-size: 0.98rem; background: #181d2b; border-radius: 8px;}
    .breakdown-table th, .breakdown-table td { padding: 7px 10px; text-align: left; border-bottom: 1px solid #232942;}
    .breakdown-table tr:last-child td { border-bottom: none;}
    .risk-flag { color: #ffd966; font-size: 1.2em; vertical-align: middle; margin-left: 8px; cursor: pointer;}
    .chart-container canvas { width: 100% !important; height: auto !important; max-height: 140px !important; margin-top: 8px; display: block;}
    @media (max-width:1150px) { #main-wrap {flex-direction: column; align-items:center; gap:18px;}}
    @media (max-width:800px) { #main-wrap {padding:18px 1vw 60px 1vw;} .panel, .chart-container, .ai-tutor-panel, .learning-dashboard {max-width:98vw;} }
    .history-section { background: #182336; border-radius: 7px; padding: 10px 14px; margin-top: 24px;}
    .history-list { color: #bdf7eb; font-size: 0.98em; margin-top: 6px;}
    .whatif-section { margin-top: 22px; background: #1a2440; border-radius: 9px; padding: 13px 12px;}
    .whatif-slider { width: 95%; margin: 7px 0 0 0;}
    .slider-label { color: #b7f6be; font-size: 0.97em; margin-top: 2px; margin-bottom: 2px;}
    .rss-feed { margin:14px 0; background: #182336; border-radius: 7px; padding: 10px 10px;}
    .rss-title { color: #b7f6be; font-size:1.08em; margin-bottom:7px;}
    .rss-item { margin-bottom:7px; font-size:0.98em;}
    .import-export-row { display:flex; gap:12px; align-items:center; margin-top:10px;}
    #importInput { display:none; }
    .wizard-modal-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background:rgba(21,34,54,0.81); z-index:10001; display: flex; align-items: center; justify-content: center;}
    .wizard-modal { background: #172343; border-radius:16px; padding:34px 28px 26px 28px; max-width:440px; min-width:280px; box-shadow: 0 10px 48px rgba(0,0,0,0.46);}
    .wizard-step-title { font-size:1.25em; margin-bottom:9px; font-weight:bold;}
    .wizard-explain { color:#b2eaff; font-size:0.98em; margin-bottom:12px;}
    .wizard-controls { margin-top:18px; display:flex; gap:13px; }
    .badge {display:inline-block; background:#00b48a; color:#fff; border-radius:10px; padding:4px 12px; margin:2px 0 2px 0; font-size:0.99em;}
    .learning-dashboard { padding:14px 18px 17px 18px; font-size:1.02em; margin-top: 28px;}
    .learning-badge-list {display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .learning-tip {background:#204a89; border-radius:6px; padding:7px 11px; margin:8px 0 0 0; color:#b2eaff;}
    .ai-tutor-panel {border:1.2px solid #244c8b; min-height:360px;}
    .tutor-title {font-size:1.17em; color:#b7f6be; font-weight:bold;}
    .tutor-messages {background:#172343; border-radius:7px; padding:7px 10px; height:180px; overflow-y:auto; margin-bottom:7px;}
    .tutor-message {margin-bottom:8px;}
    .tutor-message.user {color:#95b4ff; text-align:right;}
    .tutor-message.ai {color:#99ffd6; text-align:left;}
    .tutor-input-row {display:flex; gap:5px;}
    .tutor-input {flex:1; padding:7px 7px; border-radius:7px; border:none; background:#21295a; color:#fff;}
    .tutor-send-btn {background:#00b48a; border:none; border-radius:7px; color:#fff; font-weight:bold; padding:7px 14px; cursor:pointer;}
    .scenario-library {background:#193858; border-radius:7px; padding:10px 15px 9px 15px; margin:11px 0;}
    .scenario-btn {background:#0ec3be; color:#fff; border:none; border-radius:7px; margin-right:8px; margin-bottom:5px; padding:7px 11px; cursor:pointer;}
    .explanation-section {margin-top:22px;}
    details[open] > summary::marker { color: #00b48a;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="main-wrap">
    <!-- Main trade panel -->
    <div class="panel" aria-label="CopperDesk Trade Panel">
      <h1>
        CopperDesk PRO <span class="tooltip" data-info="general">ℹ</span>
        <span class="glossary-link" id="glossaryBtn">Glossary/FAQ</span>
      </h1>
      <div class="feature-banner">
        <b>NEW:</b> Guided trade wizard, scenario library, step-by-step tips, AI tutor, advanced explanations, badges.  
        <button class="btn-small" id="openWizardBtn" style="float:right;margin-top:-3px;">🧑‍🏫 Trade Wizard</button>
      </div>
      <div class="helper">
        Enter your deal to analyse true margin, FX, risk, and save. <span class="explain-link" data-info="howitworks">(How?)</span>
      </div>
      <div class="scenario-library">
        <b>📂 Load a beginner scenario:</b>
        <button class="scenario-btn" data-scenario="basic-copper">Copper Import (USD→EUR)</button>
        <button class="scenario-btn" data-scenario="basic-gold">Gold Export (USD→JPY)</button>
        <button class="scenario-btn" data-scenario="low-margin">Low Margin Risk</button>
        <button class="scenario-btn" data-scenario="hedged">Hedged FX Example</button>
      </div>
      <form id="tradeForm" autocomplete="off" onsubmit="return false;">
        <div id="tradeFields"></div>
        <div class="import-export-row">
          <a href="#" class="btn btn-small" id="exportCSV">Export CSV</a>
          <a href="#" class="btn btn-small" id="importCSVBtn">Import CSV</a>
          <input type="file" id="importInput" accept=".csv" />
          <a href="#" class="btn btn-small" id="saveHistory">Save Trade</a>
        </div>
        <button class="btn" id="calcBtn" type="button">Calculate</button>
      </form>
      <div class="result" id="result"></div>
      <div class="score-output" id="score"></div>
      <div id="breakdown"></div>
      <div class="whatif-section">
        <b>Sensitivity / What-If Analysis</b>
        <div class="slider-label">Adjust FX Rate: <span id="fxSliderVal"></span></div>
        <input type="range" min="0.5" max="2.5" step="0.01" id="fxSlider" class="whatif-slider">
        <div class="slider-label">Adjust Metal Price: <span id="metalSliderVal"></span></div>
        <input type="range" min="1000" max="12000" step="10" id="metalSlider" class="whatif-slider">
      </div>
      <div class="history-section">
        <b>Trade History</b>
        <ul class="history-list" id="historyList"></ul>
      </div>
      <details class="explanation-section" id="outputExplain" open>
        <summary>What do these results mean?</summary>
        <div id="outputExplainBody"></div>
      </details>
    </div>
    <div class="chart-container" aria-label="FX Rate Trend">
      <h2>FX Rate Trend <span class="tooltip" data-info="chart">ℹ</span></h2>
      <canvas id="fxChart" height="70"></canvas>
      <div class="rss-feed" id="rssFeed">
        <div class="rss-title">Latest Metals News</div>
        <div id="rssItems"><em>Loading...</em></div>
      </div>
    </div>
    <div class="ai-tutor-panel" id="aiTutorPanel">
      <div class="tutor-title">AI Trade Tutor</div>
      <div class="tutor-messages" id="tutorMessages">
        <div class="tutor-message ai">Hi! I’m your CopperDesk Tutor.  
        Ask me anything about trading, risk, terms, margin, or how to use this tool.</div>
      </div>
      <div class="tutor-input-row">
        <input type="text" id="tutorInput" class="tutor-input" placeholder="Type your question...">
        <button class="tutor-send-btn" id="tutorSendBtn">Send</button>
      </div>
    </div>
    <div class="learning-dashboard" id="learningDashboard">
      <b>Learning Progress</b>
      <div class="learning-badge-list" id="badgeList"></div>
      <div class="learning-tip" id="learningTip"></div>
    </div>
  </div>
  <div id="wizardModal" style="display:none;"></div>
  <div id="infoPopups"></div>
  <script>
// --- FIELD CONFIGURATION, OPTIONS ---
const tradeFieldsConfig = [
  { id: "metal", label: "Select Metal", type: "select", options: [{value:"XCU",label:"Copper"},{value:"XAU",label:"Gold"}], explainKey: "metal" },
  { id: "buyCurrency", label: "Buy Currency", type: "select", options: "currencies", explainKey: "buycur" },
  { id: "sellCurrency", label: "Sell Currency", type: "select", options: "currencies", explainKey: "sellcur" },
  { id: "purchasePrice", label: "Purchase Price per tonne (Buy Currency)", type: "number", default: 8200, explainKey: "purchasePrice" },
  { id: "quantity", label: "Quantity (tonnes)", type: "number", default: 10, explainKey: "quantity" },
  { id: "freight", label: "Freight per tonne (Sell Currency)", type: "number", default: 0, explainKey: "freight" },
  { id: "insurance", label: "Insurance per tonne (Sell Currency)", type: "number", default: 0, explainKey: "insurance" },
  { id: "duty", label: "Import Duty per tonne (Sell Currency)", type: "number", default: 0, explainKey: "duty" },
  { id: "warehouse", label: "Warehousing per tonne (Sell Currency)", type: "number", default: 0, explainKey: "warehouse" },
  { id: "demurrage", label: "Demurrage per tonne (Sell Currency)", type: "number", default: 0, explainKey: "demurrage" },
  { id: "customs", label: "Customs per tonne (Sell Currency)", type: "number", default: 0, explainKey: "customs" },
  { id: "bankfees", label: "Bank Fees per tonne (Sell Currency)", type: "number", default: 0, explainKey: "bankfees" },
  { id: "vat", label: "VAT (%)", type: "number", default: 0, explainKey: "vat", attrs: { min:0, max:100, step:0.01 } },
  { id: "sellingPrice", label: "Selling Price per tonne (Sell Currency)", type: "number", default: 8300, explainKey: "sellingPrice" },
  { id: "paymentTerm", label: "Payment Terms (Incoterm)", type: "select", options: "incoterms", explainKey: "incoterm" },
  { id: "fxForward", label: "Use Forward FX Rate (optional)", type: "number", explainKey: "fxforward", attrs:{step:0.0001,placeholder:"Leave blank for spot rate"} },
  { id: "hedgeCost", label: "FX Hedge Premium per tonne (Sell Currency)", type: "number", default: 0, explainKey: "hedgecost" },
  { id: "notes", label: "Trade Notes", type: "textarea", default: "", explainKey: "notes", attrs:{maxlength:5000,placeholder:"Enter notes, contacts, counterparty, etc."} },
];
const currencySymbols = { USD: "$", EUR: "€", DKK: "kr", GBP: "£", CAD: "$", NOK: "kr", SEK: "kr", JPY: "¥" };
const currencies = ["USD", "EUR", "DKK", "GBP", "CAD", "NOK", "SEK", "JPY"];
const incoterms = [
  { value: "FOB", label: "FOB (Free On Board)" },
  { value: "CIF", label: "CIF (Cost, Insurance, Freight)" },
  { value: "EXW", label: "EXW (Ex Works)" },
  { value: "DAP", label: "DAP (Delivered at Place)" },
  { value: "DDP", label: "DDP (Delivered Duty Paid)" },
  { value: "FCA", label: "FCA (Free Carrier)" },
  { value: "CPT", label: "CPT (Carriage Paid To)" },
  { value: "CIP", label: "CIP (Carriage and Insurance Paid To)" },
  { value: "FAS", label: "FAS (Free Alongside Ship)" },
  { value: "CFR", label: "CFR (Cost and Freight)" },
  { value: "DAT", label: "DAT (Delivered at Terminal)" },
  { value: "LC30", label: "Letter of Credit (30 Days)" },
  { value: "LC60", label: "Letter of Credit (60 Days)" },
  { value: "LC90", label: "Letter of Credit (90 Days)" }
];
const incotermDetails = {
  "FOB": "Seller delivers goods on board vessel at port of shipment. Buyer bears all costs and risks after loading.",
  "CIF": "Seller pays for cost, insurance, freight to named port. Risk passes to buyer when goods loaded on vessel.",
  "EXW": "Buyer bears all costs/risk from seller's premises onwards.",
  "DAP": "Seller delivers to a named place. Buyer pays for import duties/taxes.",
  "DDP": "Seller responsible for all costs and risks, including duties/taxes, to deliver at destination.",
  "FCA": "Seller delivers goods to carrier or other person nominated by buyer at seller’s premises or another named place.",
  "CPT": "Seller pays freight to named place. Risk transfers once delivered to first carrier.",
  "CIP": "Seller pays freight/insurance to destination. Risk passes to buyer at carrier handover.",
  "FAS": "Seller delivers alongside ship at named port. Buyer bears costs/risk from that point.",
  "CFR": "Seller pays costs/freight to port. Risk passes when goods loaded on vessel.",
  "DAT": "Seller delivers to named terminal at destination. Buyer pays import duties.",
  "LC30": "Payment via letter of credit, payable 30 days after shipment/documents.",
  "LC60": "Payment via letter of credit, payable 60 days after shipment/documents.",
  "LC90": "Payment via letter of credit, payable 90 days after shipment/documents."
};
const infoData = {
  general: "CopperDesk is a professional tool for physical copper/gold traders: calculate landed cost, profit, risk, FX, and explore what-if scenarios. Sensitivity, notes, history, export/import, glossary, news.",
  howitworks: "<b>How it works:</b><br>1. Enter trade details.<br>2. Live gold (XAU) or reference copper (XCU) price.<br>3. FX from live feed.<br>4. Sensitivity/what-if for FX, metal price.<br>5. Save/export your scenario. <br>6. Glossary: click for definitions anywhere.",
  metal: "Select your trade metal. Gold is live (per troy ounce/tonne), copper uses reference (LME not free).",
  buycur: "Currency you use to pay supplier (purchase side).",
  sellcur: "Currency you invoice/sell in (sales side).",
  fxrate: "FX rate from buy to sell currency (10-day spot average). Set custom forward rate if hedged.",
  purchasePrice: "Your contracted or spot purchase price per tonne, in buy currency.",
  quantity: "Total trade quantity (tonnes).",
  freight: "Transport/shipping cost per tonne (sell currency).",
  insurance: "Insurance cost per tonne (sell currency).",
  duty: "Import duty per tonne (sell currency).",
  warehouse: "Warehousing/storage per tonne (sell currency).",
  demurrage: "Demurrage per tonne (extra port/storage charges for delays).",
  customs: "Customs clearance per tonne (sell currency).",
  bankfees: "Bank fees, LC costs per tonne (sell currency).",
  vat: "Value Added Tax as % of total cost.",
  sellingPrice: "Your sales contract or target price per tonne (sell currency).",
  incoterm: "Delivery/payment terms (Incoterms). Click for details.",
  fxforward: "Set if you hedged FX at a fixed rate. Blank = use spot rate.",
  hedgecost: "FX hedge premium per tonne, in sell currency.",
  notes: "Record contacts, counterparties, negotiation points, compliance etc.",
  chart: "10-day FX spot rate trend.",
  margin: "<b>Margin</b> = (Profit / Total Cost) × 100.<br>Below 5% = high risk.",
  tradescore: "<b>Trade Score</b>: Combines margin and payment term risk.",
};
// --- Glossary ---
const glossary = {
  "Landed Cost": "The total cost of a product once it has arrived at a buyer’s door. Includes purchase, freight, insurance, duties, warehouse, etc.",
  "FX": "Foreign exchange rate. The value of one currency for the purpose of conversion to another.",
  "Incoterms": "Standard trade definitions published by the ICC defining who is responsible for costs/risks.",
  "Hedge": "A risk management strategy used to offset losses in investments.",
  "Demurrage": "Fees for excessive time in port/storage beyond agreed period.",
  "Bank Fees": "Charges for financial transactions, e.g., for LCs, swift, etc.",
  "Letter of Credit": "A payment method offering security to both buyer and seller.",
  "VAT": "Value Added Tax. A government-imposed tax.",
  "Spot Rate": "Current market FX rate.",
  "Forward Rate": "Agreed FX rate for a future transaction.",
  "Sensitivity/What-If": "Scenario analysis: test how margin/profit responds to FX or price changes.",
  "Trade Notes": "Optional notes for each deal, such as compliance, counterparties, or commercial comments.",
  "Import/Export": "Download/upload all trade data as CSV for further analysis or record-keeping.",
  "RSS Feed": "Live news feed for metals industry updates.",
  "Industry Margin": "Typical gross margin for physical metals trades, often 1-6%. <br>(Consult your compliance team for best practice!)"
};

// --- DYNAMIC FORM RENDER ---
const tradeFieldsDiv = document.getElementById("tradeFields");
function renderTradeFields() {
  tradeFieldsDiv.innerHTML = "";
  for (const f of tradeFieldsConfig) {
    let label = `<div class="label-row"><label for="${f.id}">${f.label}</label><span class="explain-link" data-info="${f.explainKey}">(?)</span></div>`;
    let input = "";
    if (f.type === "select") {
      let opts = "";
      if (f.options === "currencies")
        opts = currencies.map(c => `<option value="${c}">${c}</option>`).join('');
      else if (f.options === "incoterms")
        opts = incoterms.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      else
        opts = f.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('');
      input = `<select id="${f.id}" aria-label="${f.label}">${opts}</select>`;
    } else if (f.type === "textarea") {
      input = `<textarea id="${f.id}" ${f.attrs?Object.entries(f.attrs).map(([k,v])=>`${k}="${v}"`).join(' '):""}></textarea>`;
    } else {
      input = `<input id="${f.id}" type="${f.type}" ${f.default!==undefined?`value="${f.default}"`:""} ${f.attrs?Object.entries(f.attrs).map(([k,v])=>`${k}="${v}"`).join(' '):""} />`;
    }
    tradeFieldsDiv.innerHTML += label + input;
  }
}
renderTradeFields();

// --- FIELD REFERENCES ---
const $ = id => document.getElementById(id);
const getFieldVal = id => {
  const f = $(id);
  return f.type === "number" ? parseFloat(f.value) : f.value;
};
// Helper to set default field values on scenarios
function setTradeFields(data) {
  for (let [k, v] of Object.entries(data)) {
    if ($(k)) $(k).value = v;
  }
}

// --- FX/METAL LIVE RATES ---
let fxRate = 1.0, lastFxChart = null, lastFx = null, lastMetalPrice = 8600, lastMetalName = "Copper";
const fxChartCanvas = $("fxChart").getContext("2d");
const fxSlider = $("fxSlider"), fxSliderVal = $("fxSliderVal");
const metalSlider = $("metalSlider"), metalSliderVal = $("metalSliderVal");
function getAspectRatio() { return window.innerWidth > 700 ? 5 : 2.2; }

async function updateFXRateAndChart() {
  const from = $("buyCurrency").value, to = $("sellCurrency").value;
  if (from === to) {
    fxRate = 1.0;
    fxSlider.value = "1.0";
    fxSliderVal.textContent = "1.0";
    if (lastFxChart) lastFxChart.destroy();
    return;
  }
  try {
    const end = new Date().toISOString().split("T")[0];
    const start = new Date(Date.now() - 10 * 86400000).toISOString().split("T")[0];
    const res = await fetch(`https://api.frankfurter.app/${start}..${end}?from=${from}&to=${to}`);
    if (!res.ok) throw new Error("API error");
    const data = await res.json();
    const entries = Object.entries(data.rates);
    const labels = entries.map(([date]) => date);
    const values = entries.map(([, val]) => val[to]).filter(v => typeof v === "number");
    fxRate = values.at(-1);
    fxSlider.value = fxRate.toFixed(4);
    fxSliderVal.textContent = fxRate.toFixed(4);
    if (lastFxChart) lastFxChart.destroy();
    lastFxChart = new Chart(fxChartCanvas, {
      type: 'line',
      data: { labels: labels, datasets: [{ label: `${from} → ${to}`, data: values, borderWidth: 2, fill: false }] },
      options: {
        responsive: true, maintainAspectRatio: true, aspectRatio: getAspectRatio(),
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: { x: { ticks: { color: '#fff' } }, y: { ticks: { color: '#fff' } } }
      }
    });
    updateWhatIfFxSlider();
  } catch (e) {
    fxRate = 1.0;
    fxSlider.value = "1.0";
    fxSliderVal.textContent = "1.0";
    if (lastFxChart) lastFxChart.destroy();
  }
}
async function getMetalPrice() {
  const metal = $("metal").value;
  try {
    if (metal === "XAU") {
      const res = await fetch(`https://api.metals.live/v1/spot/gold`);
      const data = await res.json();
      const ouncePrice = Array.isArray(data) && typeof data[0]?.gold === "number" ? data[0].gold : null;
      if (!ouncePrice) throw new Error();
      lastMetalPrice = ouncePrice * 32150;
      lastMetalName = "Gold";
    } else {
      lastMetalPrice = 8600;
      lastMetalName = "Copper";
    }
    updateWhatIfMetalSlider();
  } catch {
    lastMetalPrice = 8600; lastMetalName = metal === "XAU" ? "Gold" : "Copper";
  }
}

// --- WHAT-IF SENSITIVITY SLIDERS ---
function updateWhatIfFxSlider() {
  fxSlider.min = (fxRate * 0.5).toFixed(4);
  fxSlider.max = (fxRate * 1.5).toFixed(4);
  fxSlider.value = fxRate.toFixed(4);
  fxSliderVal.textContent = fxSlider.value;
}
function updateWhatIfMetalSlider() {
  metalSlider.min = lastMetalPrice * 0.5;
  metalSlider.max = lastMetalPrice * 1.5;
  metalSlider.value = lastMetalPrice;
  metalSliderVal.textContent = lastMetalPrice;
}
fxSlider.oninput = function () {
  fxSliderVal.textContent = this.value;
  calculate({ fx: parseFloat(this.value) });
};
metalSlider.oninput = function () {
  metalSliderVal.textContent = this.value;
  calculate({ liveMetalPrice: parseFloat(this.value), purchasePrice: parseFloat(this.value) });
};

// --- CALCULATION / LOGIC ---
function getFormData(override = {}) {
  const d = {};
  tradeFieldsConfig.forEach(f => {
    d[f.id] = override[f.id] !== undefined ? override[f.id] : getFieldVal(f.id);
  });
  d.fx = override.fx ?? fxRate;
  d.metalName = lastMetalName;
  d.liveMetalPrice = override.liveMetalPrice ?? lastMetalPrice;
  d.date = new Date().toLocaleString();
  d.buyCur = $("buyCurrency").value;
  d.sellCur = $("sellCurrency").value;
  d.paymentTerm = $("paymentTerm").value;
  return d;
}
function calculate(override={}) {
  // Validate
  let valid = true;
  tradeFieldsConfig.forEach(f => {
    const inp = $(f.id), v = inp.type === 'textarea' ? inp.value : Number(inp.value);
    if ((inp.type !== 'textarea' && (isNaN(v) || v < 0)) || (inp.type === 'textarea' && v.length > 5000)) {
      inp.classList.add("invalid"); valid = false;
    } else inp.classList.remove("invalid");
  });
  if (!valid) {
    $("result").textContent = "Please fill all fields correctly!";
    return;
  }
  const d = getFormData(override);
  let fx = d.fxForward ? parseFloat(d.fxForward) : d.fx;
  if (!fx || fx <= 0) fx = 1.0;
  let purchaseTotal = parseFloat(d.purchasePrice) * d.quantity * fx;
  let costList = ["freight","insurance","duty","warehouse","demurrage","customs","bankfees"].map(k => parseFloat(d[k]) * d.quantity);
  let totalCosts = purchaseTotal + costList.reduce((a,b) => a + b, 0);
  let vatAmt = totalCosts * (parseFloat(d.vat) || 0) / 100;
  let hedgeAmt = (parseFloat(d.hedgeCost)||0) * d.quantity;
  let totalAll = totalCosts + vatAmt + hedgeAmt;
  let revenue = parseFloat(d.sellingPrice) * d.quantity;
  let profit = revenue - totalAll;
  let margin = totalAll ? (profit / totalAll * 100) : 0;
  // Trade Score (beginner mode: margin + incoterm + hedging + fx)
  let score = 0;
  if (margin > 6) score += 3;
  else if (margin > 3) score += 2;
  else if (margin > 1) score += 1;
  if (["DDP","CIF","DAP","CIP"].includes(d.paymentTerm)) score += 1;
  if (d.fxForward) score += 1;
  if (hedgeAmt>0) score += 1;
  let verdict = score >= 5 ? "Strong" : score >= 3 ? "Watch Margin" : "Risky";
  // Output
  $("result").className = "result " + (margin > 6 ? "success" : margin > 2 ? "warning" : "danger");
  $("result").innerHTML =
    `<b>Profit:</b> ${revenue-totalAll >=0?'+':''}${(revenue-totalAll).toFixed(2)} ${d.sellCur} <br>` +
    `<b>Margin:</b> ${margin.toFixed(2)}% ${margin < 5 ? "<span class='risk-flag' title='Low margin, risky!'>⚠️</span>":""}`;
  $("score").className = "score-output " + (score>=5?"success":score>=3?"warning":"danger");
  $("score").innerHTML = `<b>Trade Score:</b> ${score} / 6 <br> Verdict: <b>${verdict}</b>`;
  // Breakdown
  $("breakdown").innerHTML = `<table class="breakdown-table">
    <tr><th>Item</th><th>Amount (${d.sellCur})</th></tr>
    <tr><td>Purchase (FX Applied)</td><td>${purchaseTotal.toFixed(2)}</td></tr>
    <tr><td>Freight</td><td>${(parseFloat(d.freight)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>Insurance</td><td>${(parseFloat(d.insurance)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>Duty</td><td>${(parseFloat(d.duty)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>Warehousing</td><td>${(parseFloat(d.warehouse)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>Demurrage</td><td>${(parseFloat(d.demurrage)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>Customs</td><td>${(parseFloat(d.customs)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>Bank Fees</td><td>${(parseFloat(d.bankfees)*d.quantity).toFixed(2)}</td></tr>
    <tr><td>FX Hedge Premium</td><td>${hedgeAmt.toFixed(2)}</td></tr>
    <tr><td>VAT</td><td>${vatAmt.toFixed(2)}</td></tr>
    <tr><td><b>Total Cost</b></td><td><b>${totalAll.toFixed(2)}</b></td></tr>
    <tr><td><b>Revenue</b></td><td><b>${revenue.toFixed(2)}</b></td></tr>
    <tr><td><b>Profit</b></td><td><b>${(revenue-totalAll).toFixed(2)}</b></td></tr>
    <tr><td><b>Margin</b></td><td><b>${margin.toFixed(2)}%</b></td></tr>
  </table>`;
  // Save for scenario reload, history, badges, tips
  window.__lastTradeData = {...d, margin, profit: revenue-totalAll, score, verdict};
  updateLearning();
  return window.__lastTradeData;
}

// --- LEARNING, BADGES, TIPS, QUIZ ---
function updateLearning() {
  // Badges
  const badges = [];
  const d = window.__lastTradeData;
  if (!d) return;
  if (d.margin > 6) badges.push("Strong Margin");
  if (d.hedgeCost > 0 || d.fxForward) badges.push("FX Hedged");
  if (["DDP","CIF","DAP","CIP"].includes(d.paymentTerm)) badges.push("Buyer-friendly Term");
  if (d.vat > 0) badges.push("VAT Accounted");
  if (d.notes && d.notes.length>25) badges.push("Notes Added");
  if (d.profit > 0) badges.push("Profitable");
  $("badgeList").innerHTML = badges.map(b=>`<span class="badge">${b}</span>`).join("");
  // Learning tip
  let tip = "";
  if (d.margin < 3) tip = "Margin under 3% is high risk. Review costs, FX, or renegotiate price.";
  else if (d.margin > 10) tip = "Unusually high margin – check for data entry errors or market realism.";
  else if (d.hedgeCost > 0) tip = "You included an FX hedge! That reduces risk for volatile currencies.";
  else if (d.paymentTerm === "FOB") tip = "FOB is standard for global trade, but exposes buyer to freight/insurance risks.";
  else if (d.paymentTerm === "DDP") tip = "DDP gives your buyer most comfort, but seller bears max risk/cost.";
  $("learningTip").textContent = tip;
}

// --- TRADE WIZARD ---
const wizardSteps = [
  { title: "Welcome!", explain: "This wizard walks you through a beginner trade step-by-step." },
  { title: "Step 1: Metal", explain: "Select your trade metal. Start with Copper.", set: { metal: "XCU" }},
  { title: "Step 2: Currencies", explain: "Set buy currency (USD), sell currency (EUR).", set: { buyCurrency: "USD", sellCurrency: "EUR" }},
  { title: "Step 3: Purchase", explain: "Enter purchase price per tonne (e.g. 8500), quantity (10).", set: { purchasePrice: 8500, quantity: 10 }},
  { title: "Step 4: Costs", explain: "Add any costs if known (freight, insurance). Leave blank for now.", set: { freight: 0, insurance: 0 }},
  { title: "Step 5: Selling", explain: "Enter selling price per tonne (e.g. 8800).", set: { sellingPrice: 8800 }},
  { title: "Step 6: Terms", explain: "Set payment term to 'FOB'.", set: { paymentTerm: "FOB" }},
  { title: "Step 7: Done!", explain: "Click 'Calculate'. Review margin, try What-If sliders!" }
];
$("openWizardBtn").onclick = () => {
  let step = 0;
  showWizard(step);
  function showWizard(s) {
    const w = $("wizardModal");
    w.style.display = "flex";
    w.innerHTML = `<div class="wizard-modal-bg" onclick="this.parentNode.style.display='none'"></div>
      <div class="wizard-modal">
        <div class="wizard-step-title">${wizardSteps[s].title}</div>
        <div class="wizard-explain">${wizardSteps[s].explain}</div>
        <div class="wizard-controls">
          ${s>0?'<button class="btn btn-small" id="wizPrev">Prev</button>':''}
          ${s<wizardSteps.length-1?'<button class="btn btn-small" id="wizNext">Next</button>':'<button class="btn btn-small" id="wizDone">Done</button>'}
        </div>
      </div>`;
    Object.entries(wizardSteps[s].set||{}).forEach(([k,v])=>{$(k).value = v;});
    if (s==wizardSteps.length-1) calculate();
    $("wizPrev") && ($("wizPrev").onclick = ()=>showWizard(s-1));
    $("wizNext") && ($("wizNext").onclick = ()=>showWizard(s+1));
    $("wizDone") && ($("wizDone").onclick = ()=>{w.style.display="none";});
  }
};

// --- SCENARIO LIBRARY ---
document.querySelectorAll(".scenario-btn").forEach(btn => {
  btn.onclick = () => {
    let sc = btn.dataset.scenario, data = {};
    if (sc === "basic-copper")
      data = { metal:"XCU", buyCurrency:"USD", sellCurrency:"EUR", purchasePrice:8400, quantity:15, sellingPrice:8700, paymentTerm:"CIF" };
    if (sc === "basic-gold")
      data = { metal:"XAU", buyCurrency:"USD", sellCurrency:"JPY", purchasePrice:62000, quantity:2, sellingPrice:67000, paymentTerm:"CIP" };
    if (sc === "low-margin")
      data = { metal:"XCU", buyCurrency:"USD", sellCurrency:"EUR", purchasePrice:8600, quantity:10, sellingPrice:8680, paymentTerm:"FCA" };
    if (sc === "hedged")
      data = { metal:"XCU", buyCurrency:"USD", sellCurrency:"GBP", purchasePrice:8450, quantity:5, sellingPrice:8900, paymentTerm:"CPT", fxForward:0.79, hedgeCost:30 };
    setTradeFields(data);
    calculate();
  }
});

// --- AI TRADE TUTOR (LOCAL ONLY) ---
const tutorMessages = $("tutorMessages"), tutorInput = $("tutorInput"), tutorSend = $("tutorSendBtn");
function tutorSay(txt, who="ai") {
  let m = document.createElement("div");
  m.className = "tutor-message "+who;
  m.innerHTML = txt;
  tutorMessages.appendChild(m);
  tutorMessages.scrollTop = tutorMessages.scrollHeight;
}
tutorSend.onclick = () => {
  let q = tutorInput.value.trim();
  if (!q) return;
  tutorSay(q, "user");
  tutorInput.value = "";
  // Simple rule-based AI (local only)
  q = q.toLowerCase();
  let a = "I'm sorry, I didn't understand. Try asking about 'margin', 'FX', 'hedge', or 'incoterms'.";
  if (q.includes("margin")) a = "Margin = (Profit / Total Cost) × 100. Under 5% is risky, 5-10% is healthy.";
  else if (q.includes("fx")||q.includes("currency")) a = "FX rate converts buy/sell currency. Use spot or set a forward/hedged rate.";
  else if (q.includes("hedge")) a = "FX hedging locks your rate, reducing currency risk. Enter 'Use Forward FX Rate' or 'FX Hedge Premium'.";
  else if (q.includes("incoterm")||q.includes("term")) a = "Incoterms set who covers cost/risk. Click the incoterm for details.";
  else if (q.includes("profit")) a = "Profit = Revenue - Total Cost. The tool shows both in breakdown.";
  else if (q.includes("history")) a = "You can save any trade for later, and review history at the bottom left.";
  else if (q.includes("scenario")) a = "Click a scenario button to instantly load an example or try your own numbers.";
  else if (q.includes("quiz")) a = "To take a quiz, click the 'Trade Quiz' button. Good luck!";
  else if (q.includes("risk")) a = "Risk factors include low margin, volatile FX, bad payment terms, no hedging.";
  else if (q.includes("glossary")) a = "Click 'Glossary/FAQ' to search any trade term or phrase!";
  tutorSay(a);
};
tutorInput.onkeydown = e => { if (e.key === "Enter") tutorSend.onclick(); };

// --- HINTS FOR FIELDS ---
document.addEventListener('focusin', e => {
  const id = e.target.id;
  const f = tradeFieldsConfig.find(f => f.id === id);
  if (f && infoData[f.explainKey]) {
    tutorSay(`<b>Hint:</b> ${infoData[f.explainKey]}`);
  }
});

// --- QUIZ BUTTON ---
const quizBtn = document.createElement('button');
quizBtn.className = "btn btn-small";
quizBtn.innerText = "🧑‍🎓 Trade Quiz";
quizBtn.onclick = startQuiz;
document.querySelector(".feature-banner").after(quizBtn);
function startQuiz() {
  const quiz = [
    { q: "What does 'Landed Cost' mean?", a: ["Total cost after arrival (includes all costs)", "Just shipping cost", "Only purchase price", "Only VAT"], c: 0 },
    { q: "What is a safe gross margin for most physical metals trades?", a: ["0–1%", "1–6%", "10–15%", "Over 20%"], c: 1 },
    { q: "What does a low trade score (red warning) suggest?", a: ["Strong trade", "High risk", "No profit", "Needs insurance"], c: 1 }
  ];
  let idx = 0, correct = 0;
  function showQ() {
    if (idx >= quiz.length) {
      tutorSay(`<b>Quiz finished!</b> You scored ${correct} / ${quiz.length}.`);
      return;
    }
    let q = quiz[idx];
    tutorSay(`<b>${q.q}</b><br>` + q.a.map((opt, i) => `<button class="btn btn-small" onclick="__quizAns(${i})">${opt}</button>`).join(" "), "ai");
  }
  window.__quizAns = function(ans) {
    let q = quiz[idx];
    if (ans === q.c) { correct++; tutorSay("<span style='color:#5ff7b8'>Correct!</span>"); }
    else { tutorSay(`<span style='color:#ff6f8a'>Nope! Answer: ${q.a[q.c]}</span>`); }
    idx++; setTimeout(showQ, 900);
  }
  showQ();
}

// --- HISTORY ---
function renderHistory() {
  let list = JSON.parse(localStorage.getItem("copperdesk_history") || "[]");
  $("historyList").innerHTML = list.length ? list.map((tr, i) =>
    `<li>#${i+1} | ${tr.date} | <b>${tr.metalName}</b> ${tr.quantity}t | Margin: <b>${tr.margin.toFixed(2)}%</b>
      <br>Score: <b>${tr.score}/6</b> | ${tr.verdict}
      <br>Notes: <em>${tr.notes?tr.notes.replace(/</g,"&lt;").replace(/>/g,"&gt;"):"(none)"}
      <br><button class="btn btn-small" onclick="loadHistory(${i})">Load</button>
      <button class="btn btn-small" onclick="deleteHistory(${i})">Delete</button>
    </li>`
  ).join("") : "<li>No saved trades yet.</li>";
}
window.loadHistory = function(i) {
  let list = JSON.parse(localStorage.getItem("copperdesk_history") || "[]");
  if (!list[i]) return;
  setTradeFields(list[i]);
  calculate();
};
window.deleteHistory = function(i) {
  let list = JSON.parse(localStorage.getItem("copperdesk_history") || "[]");
  list.splice(i, 1); localStorage.setItem("copperdesk_history", JSON.stringify(list));
  renderHistory();
};
$("saveHistory").onclick = function (e) {
  e.preventDefault();
  let d = calculate() || getFormData();
  let list = JSON.parse(localStorage.getItem("copperdesk_history") || "[]");
  list.push(d); localStorage.setItem("copperdesk_history", JSON.stringify(list));
  renderHistory(); alert("Trade saved to history.");
};
renderHistory();

// --- CSV IMPORT/EXPORT ---
$("exportCSV").onclick = function (e) {
  e.preventDefault();
  let d = getFormData();
  let csv = Object.keys(d).join(",") + "\n" + Object.values(d).join(",");
  let blob = new Blob([csv], { type: "text/csv" });
  let url = URL.createObjectURL(blob);
  let a = document.createElement("a");
  a.href = url; a.download = "copperdesk_trade.csv";
  document.body.appendChild(a); a.click(); a.remove();
};
$("importCSVBtn").onclick = function (e) {
  e.preventDefault();
  $("importInput").click();
};
$("importInput").onchange = function (e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (ev) {
    let rows = ev.target.result.split("\n");
    if (rows.length < 2) return;
    let keys = rows[0].split(","), vals = rows[1].split(",");
    let data = {};
    keys.forEach((k, i) => data[k] = vals[i]);
    setTradeFields(data);
    calculate();
  };
  reader.readAsText(file);
};

// --- EXPLAIN OUTPUT ---
$("outputExplain").onclick = function () {
  $("outputExplainBody").innerHTML = `<b>Results Guide:</b><ul>
    <li><b>Profit</b>: Revenue minus all costs (incl. VAT, freight, etc.)</li>
    <li><b>Margin</b>: (Profit / Total Cost) × 100. Below 5% = high risk.</li>
    <li><b>Trade Score</b>: Combines margin & payment term risk for health.</li>
    <li><b>What-If</b>: Try sliders for FX or metal price to see sensitivity!</li>
    <li><b>History</b>: You can save or review trades. Learning is tracking!</li>
  </ul>
  <button class="btn btn-small" onclick="aiTutorStep(0)">Restart Guided Walkthrough</button>`;
};

// --- GLOSSARY/FAQ POPUP ---
$("glossaryBtn").onclick = function(e) {
  e.preventDefault();
  let html = '<b>Glossary / FAQ</b><input id="searchGloss" style="margin-left:8px" placeholder="Search..."/><ul style="margin-top:7px" id="glossList">';
  for (let [k,v] of Object.entries(glossary)) {
    html += `<li><b>${k}</b>:<br><span style="color:#c7ffde">${v}</span></li>`;
  }
  html += "</ul>";
  showInfoPopup(e, html);
  setTimeout(()=>{
    $("searchGloss").oninput = function(){
      let term = this.value.trim().toLowerCase();
      $("glossList").innerHTML =
        Object.entries(glossary).filter(([k,v])=>k.toLowerCase().includes(term)||v.toLowerCase().includes(term))
          .map(([k,v])=>`<li><b>${k}</b>:<br><span style="color:#c7ffde">${v}</span></li>`).join("");
    }
  },400);
};

// --- INFO/POPUP (GENERIC) ---
function showInfoPopup(e, html) {
  let pop = document.createElement("div");
  pop.className = "wizard-modal-bg";
  pop.style.zIndex = 10012;
  pop.innerHTML = `<div class="wizard-modal" style="max-width:420px;">${html}<br><button class="btn btn-small" onclick="this.parentNode.parentNode.remove()">Close</button></div>`;
  document.body.appendChild(pop);
}
document.querySelectorAll(".explain-link,.tooltip").forEach(el=>{
  el.onclick = function(e){
    const k = el.dataset.info;
    if (!k) return;
    showInfoPopup(e, `<div style='max-width:360px;'>${infoData[k] || glossary[k] || "(No info)"}</div>`);
  };
});

// --- INIT ---
async function init() {
  await updateFXRateAndChart();
  await getMetalPrice();
  updateWhatIfFxSlider();
  updateWhatIfMetalSlider();
  calculate();
}
init();
["metal", "buyCurrency", "sellCurrency"].forEach(id => $(id).onchange = async function () {
  await updateFXRateAndChart();
  await getMetalPrice();
  updateWhatIfFxSlider();
  updateWhatIfMetalSlider();
  calculate();
});
["purchasePrice","quantity","freight","insurance","duty","warehouse","demurrage","customs","bankfees","vat","sellingPrice","paymentTerm","fxForward","hedgeCost","notes"].forEach(id => $(id).oninput = function () { calculate(); });
$("calcBtn").onclick = () => calculate();

// --- RSS NEWS FEED ---
async function fetchRss() {
  // Metals news (Bloomberg, Mining.com fallback)
  let news = [];
  try {
    const res = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent("https://www.mining.com/feed/"));
    const xml = new window.DOMParser().parseFromString(JSON.parse(await res.text()).contents, "text/xml");
    news = [...xml.querySelectorAll("item")].slice(0,5).map(item => ({
      title: item.querySelector("title")?.textContent, link: item.querySelector("link")?.textContent
    }));
  } catch {
    news = [{title:"Could not load news. Try later.",link:"#"}];
  }
  $("rssItems").innerHTML = news.map(n => `<div class="rss-item"><a href="${n.link}" target="_blank">${n.title}</a></div>`).join("");
}
fetchRss();


  </script>
</body>
</html>
